<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>产品详情</title>
		<link rel="stylesheet" href="./css/reset.css" />
		<link rel="stylesheet" href="./static/css/swiper-4.2.6.min.css">
		<link rel="stylesheet" href="./css/productInfo.css" />
		<script>
			//获取浏览器页面可见高度和宽度  
	        var _PageHeight = document.documentElement.clientHeight,  
	            _PageWidth = document.documentElement.clientWidth;  
	        //计算loading框距离顶部和左部的距离（loading框的宽度为215px，高度为61px）  
	        var _LoadingTop = _PageHeight > 61 ? (_PageHeight - 61) / 2 : 0,  
	            _LoadingLeft = _PageWidth > 215 ? (_PageWidth - 215) / 2 : 0;  
	        //在页面未加载完毕之前显示的loading Html自定义内容  
	        var _LoadingHtml = 
	        '<div id="loadingDiv" style="position:absolute;left:0;width:100%;height:' + _PageHeight + 'px;top:0;background:url(./img/loading2.gif) no-repeat center center;background-size:0.4rem 0.5rem;opacity:100;filter:alpha(opacity=100) ;z-index:10000;"></div>';
	        //呈现loading效果  
	        document.write(_LoadingHtml); 
	        //监听加载状态改变  
	        document.onreadystatechange = completeLoading;     
	        //加载状态为complete时移除loading效果  
	        function completeLoading() {  
	            if (document.readyState == "complete") {  
	                var loadingMask = document.getElementById('loadingDiv');  
	                loadingMask.parentNode.removeChild(loadingMask);  
	                $("#loadingDiv").remove();
	                $("#main").css({"opacity":100,"filter":"alpha(opacity=100)"});
	            }  
	        }  
		</script>
	</head>

	<body>
		<section id="main" style="opacity:0;filter:alpha(opacity=0);">
			<div class="banner">
				<div class="swiper-container">
					<div class="swiper-wrapper">
					</div>
					<!-- 如果需要分页器 -->
					<div class="swiper-pagination"></div>
				</div>
			</div>
			<div class="goods">
				<div class="goodsPrice">
					<span class="icon">券后价</span>￥<span class="price"></span><span class="itemPrice"></span>
				</div>
				<div class="goodsName">
				</div>
				<div class="goodsState borderB5">
					<div class="quantity"></div>
					<div class="tip"></div>
				</div>
				<!--<div class="goodsInfo">
					<div class="title borderB1">宝贝详情</div>
					<div class="info">
					</div>
				</div>-->
			</div>
			<div class="header">
				<div class="wrap">
					<img src="./img/rebate_logo_icon.png" alt="" />
					<div class="text">
						<span class="red">头条TV</span>
						<span>省钱又赚钱，更多优惠券等你发现</span>
					</div>
				</div>
				<a id="dlApp" class="dlApp" href="#">下载APP</a>
			</div>
			<div class="footer">
				<a class="dlApp" id="coupon" href="#">领五元券</a>
			</div>
		</section>
		<script type="text/javascript" src="./js/rem.js"></script>
		<script type="text/javascript" src="./js/zepto.js"></script>
		<script type="text/javascript" src="./js/fastclick.js"></script>
		<script src="./static/js/swiper-4.2.6.min.js" charset="utf-8" type="text/javascript"></script>
		<script type="text/javascript">
			window.onload = function() {
				FastClick.attach(document.body);
				//获取Url地址中userId参数
				function getUrlParams(name) {
					var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); //定义正则表达式 
					var r = window.location.search.substr(1).match(reg);
					if(r != null) return unescape(r[2]);
					return null;
				};
				ajaxUrl = "http://47.104.250.210/zaotoutiao-api-home-1.0.0";
				var userID = getUrlParams("userId"),
					itemId = getUrlParams("itemId"),
					coupon = getUrlParams("coupon"),
					commissionGold = getUrlParams("commissionGold"),
					//itemUrl = getUrlParams("itemUrl"),
					tmall = getUrlParams("tmall");
					//nativeUrl = getUrlParams("nativeUrl");
				/**
				 * 	产品性情
				 * 	price1：最低最后成交价（非必需）
					price2：最高最后成交价（非必需）
					couponValue：最低优惠券面值（非必需）					
					返回商品信息：
					itemPrice 产品原价
					coupon 优惠券面额
					commission 按产品原价-优惠券面额成交以后的佣金 
					itemUrl：领券购买的H5链接
					name：商品名称
					nativeUrl：调用app打开的链接
					itemId：商品id，跟平台对应，是平台的商品ID
					sales：销量
					tmall:1是天猫 0不是天猫
				 */

				$.ajax({
					url: ajaxUrl + "/get/tao/product/",
					type: "GET",
					dataType: "json", //指定服务器返回的数据类型
					data: {
						itemId: itemId,
						userId: userID
					},
					success: function(data) {
						var data = data.data;
						console.log(data);
						var bannerImg = data.itemPicUrl.split(","),
							name = data.name,
							itemPrice = parseFloat(data.itemPrice),
							//commission = data.commission,
							itemPicUrl = data.itemPicUrl,
							//nativeUrl = data.nativeUrl,
							//itemUrl = data.itemUrl,
							//coupon = parseFloat(data.coupon),
							sales = data.sales;
							//tmall = data.tmall;
											console.log({"userId":userID,"itemId":itemId,"coupon":parseFloat(coupon),"itemPrice":itemPrice,"commissionGold":commissionGold,"tmall":tmall});
						//渲染banenr图
						var _html = "";
						console.log({
							"itemPrice": typeof itemPrice,
							"coupon": typeof coupon
						});
						if(bannerImg.length) {
							bannerImg.map(function(item, index) {
								_html += `<div class="swiper-slide" style="background-image:url(${item})"></div>`;
							});
						};
						$(".swiper-wrapper").html(_html);
						var mySwiper = new Swiper('.swiper-container', {
							autoplay: false, //可选选项，自动滑动
							initialSlide: $(this).index(),
							loop: true,
							pagination: {
								el: '.swiper-pagination',
								type: "fraction"
							}
						})
						//领券
						$(".vouchers").html("领" + coupon + "元券");
						//佣金
						$(".tip").html("购买后返" + commissionGold + "金币");
						//价格
						$(".price").html((itemPrice - coupon).toFixed(2));
						if(tmall == 0) {
							//淘宝原价
							$(".itemPrice").html("淘宝价:￥<span style='text-decoration:line-through;'>" + itemPrice + "</span>");
							//名称
							$(".goodsName").html(`
							<img src="./img/type_taobaol_icon.png" alt="" />${name} 
							`);
						} else {
							//天猫原价
							$(".itemPrice").html("天猫价:￥<span style='text-decoration:line-through;'>" + itemPrice + "</span>");
							//名称
							$(".goodsName").html(`
							<img src="./img/type_tmall_icon.png" alt="" />${name} 
							`);
						}
						//销量
						$(".quantity").html("已售  " + sales);
					}
				});
				/**
				 * 宝贝详情
				 */
				//				$.ajax({
				//					url: `https://hws.m.taobao.com/cache/mtop.wdetail.getItemDescx/4.1/?data=%7Bitem_num_id%3A${itemId}%7D&type=jsonp&dataType=jsonp&callback=jQuery172034640315678070044_1535527857648&_=1535527874218`,
				//					type: "GET",
				//					dataType: "jsonp", //指定服务器返回的数据类型
				//					jsonpCallback: "jQuery172034640315678070044_1535527857648", //指定回调函数名称
				//					success: function(data) {
				//						var data = data.data.images,
				//							_html = "";
				//						if(data.length) {
				//							data.map(function(item, index) {
				//								_html += `<img src="${item}" alt="" />	`;
				//							});
				//						}
				//						$(".info").html(_html);
				//					}
				//				});						
				/**
				 * 完美解决safari、微信浏览器下拉回弹效果和上拉空白的bug
				 * @param {Object} el 滑动元素
				 */
				var overscroll = function(el) {
					el.addEventListener('touchstart', function() {
						var top = el.scrollTop,
							totalScroll = el.scrollHeight,
							currentScroll = top + el.offsetHeight;
						if(top === 0) {
							el.scrollTop = 1;
						} else if(currentScroll === totalScroll) {
							el.scrollTop = top - 1;
						}
					});

					el.addEventListener('touchmove', function(evt) {
						if(el.offsetHeight < el.scrollHeight)
							evt._isScroller = true;
					});
				}
				overscroll(document.querySelector('#main'));
				document.body.addEventListener('touchmove', function(evt) {
					if(!evt._isScroller) {
						evt.preventDefault();
					}
				});
			}
		</script>
		<script src="https://static.lkme.cc/linkedme.min.js"></script>
		<script type="text/javascript">
			var channel = getUrlParams("channel"); //深度链接渠道
			var invitation = getUrlParams("invitation"); //邀请码
			var pageName = getUrlParams("pageName");
			var userID = getUrlParams("userId"),
				itemId = getUrlParams("itemId"),
				coupon = getUrlParams("coupon"),
				commissionGold = getUrlParams("commissionGold"),
				itemUrl = getUrlParams("itemUrl"),
				tmall = getUrlParams("tmall");
				nativeUrl = getUrlParams("nativeUrl");
			linkedme.init("0d7fcf252fa7f4ca69eba912e650eb5b", {
				type: "live"
			}, null);
			var data = {};
			data.type = "live"; //表示现在使用线上模式,如果填写"test", 表示测试模式.【可选】
			data.feature = "功能名称"; // 自定义深度链接功能，多个用逗号分隔，【可选】
			data.stage = "阶段名称"; // 自定义深度链接阶段，多个用逗号分隔，【可选】
			data.channel = "渠道链接"; // 自定义深度链接渠道，多个用逗号分隔，【可选】
			data.tags = "3"; // 自定义深度链接标签，多个用逗号分隔，【可选】
			data.ios_custom_url = ""; // 自定义iOS平台下App的下载地址，如果是AppStore的下载地址可以不用填写，需填写http或https【可选】
			data.ios_direct_open = ""; //未安装情况下，设置为true为直接打开ios_custom_url，默认为false【可选】
			data.android_custom_url = ""; // 自定义安卓平台下App的下载地址，需填写http或https【可选】
			data.android_direct_open = ""; //设置为true，所有情况下跳转android_custom_url，默认为false【可选】
			var params = {
				channel:channel,
				invitation:invitation,
				pageName:pageName,
				itemId:itemId,
				userId:userID,
				coupon:coupon,
				commissionGold:commissionGold,
				itemUrl:itemUrl,
				nativeUrl:nativeUrl,
				tmall:tmall
			};
			data.params = JSON.stringify(params); //注意单引号和双引号的位置
			linkedme.link(data, function(err, response) {
				if(err) {
				// 生成深度链接失败，返回错误对象err
				} else {
					/**
					 * 立即领取
					 */
					console.log("传递参数", data.params);
					$(".dlApp").attr("href", response.url);
				}
			}, false);
			/**
			 * 获取Url地址中userId参数   userID
			 */
			function getUrlParams(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"); //定义正则表达式 
				var r = window.location.search.substr(1).match(reg);
				if(r != null) return unescape(r[2]);
				return null;
			};
		</script>
	</body>

</html>